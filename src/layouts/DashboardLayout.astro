---
import '../styles/global.css';

const { title, currentPath } = Astro.props;
const user = Astro.locals.user;
const email = user.email;
const activeClass = "text-secondary bg-secondary/5 rounded-xl font-semibold";

const navLinks = [
  { href: "/dashboard", text: "Inicio", icon: "dashboard.svg" },
  { href: "/dashboard/gestionar-productos", text: "Productos", icon: "package_2.svg" },
  { href: "/dashboard/gestionar-categorias", text: "Categorías", icon: "category.svg" },
  { href: "/dashboard/mensajes-clientes", text: "Mensajes", icon: "mail.svg" },
];
---

<!doctype html>
<html lang="en" class="scroll-smooth">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
		<meta name="description" content="Alimentos Venepan: panes, cereales, soya y productos nutritivos elaborados con ingredientes naturales para una vida saludable en Venezuela." />
		<meta name="generator" content={Astro.generator} />
		<meta name="color-scheme" content="light only">
		<title>{title}</title>
	</head>
	<body class="flex min-h-screen">
		<main class="bg-light-blue-dashboard h-full w-full flex relative">
			<!-- Mobile Menu Button (Hamburger) -->
			<button 
				id="mobile-menu-btn" 
				class="md:hidden fixed top-4 right-4 z-50 p-2 bg-white rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50"
				aria-label="Toggle menu"
			>
				<svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
				</svg>
			</button>

			<!-- Mobile Overlay -->
			<div id="mobile-overlay" class="md:hidden fixed inset-0 bg-gray-800/30 z-30 hidden"></div>

			<!-- Sidebar -->
            <aside id="sidebar" class="bg-white w-4/5 md:w-1/5 fixed top-0 -left-full md:left-0 h-screen max-h-dvh p-6 flex flex-col gap-20 border-r border-gray-200 z-40 transition-all duration-300 ease-in-out">
                <section class="flex items-center gap-4">
                    <img src="/icons/logo.svg" alt="Logo" class="w-12 2xl:w-16"/>
                    
					<div class="flex flex-col">
						<h1 class="text-gray-800 font-semibold 2xl:text-lg">Alimentos Venepan</h1>
						<h2 class="text-gray-600 font-semibold text-sm 2xl:text-lg">Módulo Administrativo</h2>
					</div>
                </section>

				<nav class="flex flex-col justify-between h-full">
					<ul>
						{navLinks.map(link => {
							// Check if the current link is active
							const isActive = currentPath === link.href;
							
							return (
								<li class="mb-4 2xl:mb-8">
									<a 
										href={link.href} 
										class:list={[
											"nav-link text-sm text-gray-800 rounded-2xl block w-full px-4 py-3 cursor-pointer hover:bg-secondary/5 hover:rounded-xl hover:font-semibold hover:text-secondary 2xl:text-lg", 
											isActive && activeClass 
										]}
									>
										<img src={`/icons/${link.icon}`} alt={`${link.text} icon`} class="inline w-4 mr-4 2xl:w-6" />
										{link.text}
									</a>
								</li>
							)
						})}
					</ul>
					<div>
						<button id="signout-btn" type="submit" class="text-sm text-gray-800 text-start rounded-2xl block w-full px-4 py-3 cursor-pointer hover:bg-secondary/5 hover:rounded-xl hover:font-semibold hover:text-secondary 2xl:text-lg">
							<img src="/icons/logout.svg" alt="Cerrar Sesión" class="inline w-4 mr-4 2xl:w-6" />
							Cerrar Sesión
						</button>
						<p class="text-sm mt-2 text-gray-600 2xl:text-lg">Usuario: <span class="font-semibold 2xl:text-lg">{email}</span> </p>
					</div>
				</nav>				
            </aside>
            
			<!-- Page Content -->
			<div class="min-h-screen w-full md:w-4/5 md:ml-[20%] overflow-y-auto">
                <slot />
            </div>
		</main>

		<script>
	// Mobile menu toggle
	const mobileMenuBtn = document.getElementById('mobile-menu-btn');
	const sidebar = document.getElementById('sidebar');
	const mobileOverlay = document.getElementById('mobile-overlay');
	const navLinks = document.querySelectorAll('.nav-link');

	function openMobileMenu() {
		sidebar?.classList.remove('-left-full');
		sidebar?.classList.add('left-0');
		mobileOverlay?.classList.remove('hidden');
		document.body.style.overflow = 'hidden';
	}

	function closeMobileMenu() {
		sidebar?.classList.add('-left-full');
		sidebar?.classList.remove('left-0');
		mobileOverlay?.classList.add('hidden');
		document.body.style.overflow = '';
	}

	// Toggle menu on hamburger button click
	mobileMenuBtn?.addEventListener('click', () => {
		const isOpen = sidebar?.classList.contains('left-0');
		if (isOpen) {
			closeMobileMenu();
		} else {
			openMobileMenu();
		}
	});

	// Close menu when clicking overlay
	mobileOverlay?.addEventListener('click', closeMobileMenu);

	// Close menu when clicking nav links (on mobile)
	navLinks.forEach(link => {
		link.addEventListener('click', () => {
			if (window.innerWidth < 768) {
				closeMobileMenu();
			}
		});
	});

	// Close menu on window resize to desktop size
	window.addEventListener('resize', () => {
		if (window.innerWidth >= 768) {
			closeMobileMenu();
		}
	});
	</script>

	<script>
		const signoutBtn = document.getElementById('signout-btn');

			signoutBtn?.addEventListener('click', async () => {
				if (signoutBtn instanceof HTMLButtonElement) {
					signoutBtn.disabled = true;
					signoutBtn.textContent = 'Cerrando...';
				}

				try {
					const response = await fetch('/api/auth/signout', {
						method: 'POST',
					});
					
					const data = await response.json();

					if (response.ok && data.redirectUrl) {
						window.location.href = data.redirectUrl;
					} else {
						// En caso de error (ej: error de red o de servidor)
						alert(data.error || 'Error al cerrar sesión. Intenta recargar la página.');
					}

				} catch (error) {
					// Error de conexión de red
					alert('Error de conexión. Verifica tu red.');
				} finally {
					// Restablecer el botón en caso de error
					if (signoutBtn instanceof HTMLButtonElement) {
						signoutBtn.disabled = false;
						signoutBtn.textContent = 'Cerrar Sesión';
					}
				}
			})
		</script>
	</body>
</html>
