---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Image from 'astro/components/Image.astro';
import ConfirmationModal from '../../components/ui/ConfirmationModal.astro';
import { actions } from "astro:actions";
import type { Product as ProductType } from "../../actions/products";

let products: ProductType[] = [];

let hasError = false;
let errorMessage = "";

const { data, error } = await Astro.callAction(
    actions.products.getProducts,
    {},
);

if (error) {
    hasError = true;

    // Manejar según el código de error
    switch (error.code) {
        case "BAD_REQUEST":
            errorMessage =
                "Error al conectar con la base de datos. Por favor, recarga la página.";
            break;
        case "NOT_FOUND":
            errorMessage = "No hay productos disponibles en este momento.";
            break;
        case "INTERNAL_SERVER_ERROR":
            errorMessage =
                "Ocurrió un error en el servidor. Por favor, intenta más tarde.";
            break;
        default:
            errorMessage = "Ocurrió un error inesperado.";
    }
    console.error("Error de Action:", error.message);
} else {
    products = data || [];
}

---
<DashboardLayout currentPath='/dashboard/gestionar-productos', title='Dashboard | Gestionar Productos'>
    <section class="flex flex-col p-4 md:p-12">
        <div class="mb-6">
            <h1 class="main-title text-2xl md:text-4xl mb-2">Gestión de Productos</h1>
            <p class="text text-gray-600 max-w-[70ch]">Añade, modifica y elimina los productos que se muestran en la página "Productos" de la web de Venepan</p>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
            <input type="text" id="search-input" placeholder="Buscar producto..." class="input input-bordered bg-white w-full md:max-w-xs text-gray-800 border px-3 py-3 border-gray-300 rounded-2xl focus:ring-2 focus:ring-gray-300 focus:outline-none">
            <a href="/dashboard/producto/nuevo" class="dashboard-btn w-full md:w-auto text-center">Añadir producto</a>
        </div>  

        {
            hasError && (
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    <p>{errorMessage}</p>
                </div>
            )
        }

        <div class="relative flex flex-col h-full overflow-x-auto text-gray-800 bg-white shadow-md rounded-lg bg-clip-border">
            <table class="text-left table-auto min-w-full">
                <thead>
                    <tr>
                        <th class="p-4 border-b border-slate-300 bg-gray-100">
                            <p class="block text-sm font-medium leading-none text-gray-600">
                                Imagen
                            </p>
                        </th>
                        <th class="p-4 border-b  border-slate-300 bg-gray-100">
                            <p class="block text-sm font-medium leading-none text-gray-600">
                                Nombre
                            </p>
                        </th>
                        
                        <th class="p-4 border-b border-slate-300 bg-gray-100">
                            <p class="block text-sm font-medium leading-none text-gray-600">
                                Categoría
                            </p>
                        </th>
                        <th class="p-4 border-b border-slate-300 bg-gray-100">
                            <p class="block text-sm font-medium leading-none text-gray-600">
                                Peso
                            </p>
                        </th>
                        <th class="p-4 border-b border-slate-300 bg-gray-100">
                            <p class="block text-sm font-medium leading-none text-gray-600">Acciones</p>
                        </th>
                    </tr>
                </thead>
                <tbody id="products-table-body">
                    {
                        products.map((product) => (
                            <tr class="hover:bg-slate-50 product-row" data-product-name={product.nombre_producto.toLowerCase()}>
                               <td class="p-4 border-b border-slate-200">
                                    <Image 
                                        src={product.imagen_producto}
                                        alt="Imagen del producto"
                                        class="w-8 h-8 object-contain"
                                        inferSize={true}
                                    />
                                </td> 
                                <td class="p-4 border-b border-slate-200">
                                    <p class="block  font-medium text-gray-800">
                                        {product.nombre_producto}
                                    </p>
                                </td>
                                <td class="p-4 border-b border-slate-200">
                                    <div class={`text-sm text-center font-medium w-20 px-2 py-1 rounded-full ${
                                        product.sgp_m_categorias?.nombre_categoria === 'Panes' 
                                            ? 'bg-orange-100 text-orange-500' 
                                            : product.sgp_m_categorias?.nombre_categoria === 'Cereales'
                                                ? 'bg-blue-100 text-blue-500'
                                                : product.sgp_m_categorias?.nombre_categoria === 'Soya'
                                                    ? 'bg-green-100 text-green-500'
                                                    : 'bg-gray-100 text-gray-500'
                                    }`}>
                                        {product.sgp_m_categorias?.nombre_categoria || 'Sin categoría'}
                                    </div>
                                </td>
                                <td class="p-4 border-b border-slate-200">
                                    <p class="block font-medium text-gray-600">
                                        {product.peso_producto}g
                                    </p>
                                </td>
                                <td class="p-4 border-b border-slate-200">
                                    <div class="flex gap-2">
                                        <a href={`/dashboard/producto/${product.id_producto}`} class="p-2 hover:bg-slate-100 rounded-lg transition-colors group relative" title="Editar">
                                            <img src="/icons/edit.svg" alt="Editar" class="w-4 h-4" />
                                        </a>
                                        <button 
                                            class="p-2 hover:bg-red-50 rounded-lg transition-colors group relative delete-btn" 
                                            title="Eliminar"
                                            data-id={product.id_producto}
                                            data-name={product.nombre_producto}
                                        >
                                            <img src="/icons/delete.svg" alt="Eliminar" class="w-4 h-4" />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))
                    }
                </tbody>
            </table>
        </div>
    </section>

    <ConfirmationModal 
        id="delete_product_modal"
        title="Eliminar producto"
        message="¿Estás seguro de que deseas eliminar este producto? Esta acción eliminará permanentemente el producto y su imagen asociada."
        confirmText="Sí, eliminar"
        cancelText="Cancelar"
    />

</DashboardLayout>

<script>
    import { actions } from "astro:actions";

    // Búsqueda en tiempo real
    const searchInput = document.getElementById('search-input');
    const tableBody = document.getElementById('products-table-body');

    searchInput?.addEventListener('input', (e) => {
        // @ts-ignore
        const searchTerm = e.target.value.toLowerCase().trim();
        const rows = tableBody?.getElementsByClassName('product-row');

        if (rows) {
            Array.from(rows).forEach((row) => {
                // @ts-ignore
                const productName = row.dataset.productName || '';
                if (productName.includes(searchTerm)) {
                    // @ts-ignore
                    row.style.display = '';
                } else {
                    // @ts-ignore
                    row.style.display = 'none';
                }
            });
        }
    });

    // Manejo de eliminación con Modal
    const deleteButtons = document.querySelectorAll('.delete-btn');

    deleteButtons.forEach(button => {
        button.addEventListener('click', () => {
             // @ts-ignore
             const productId = button.dataset.id;
             // @ts-ignore
             const productName = button.dataset.name;

             const message = productName 
                ? `¿Estás seguro de que deseas eliminar el producto "${productName}"? Esta acción eliminará permanentemente el producto y su imagen asociada.`
                : undefined;

             // @ts-ignore
             if (window.openModal_delete_product_modal) {
                 // @ts-ignore
                 window.openModal_delete_product_modal(async () => {
                     if (!productId) return;
                     
                     // Cambiar cursor a wait
                     document.body.style.cursor = 'wait';
                     
                     try {
                        // @ts-ignore
                         const { error } = await actions.products.deleteProduct({ id: productId });
                         
                         if (error) {
                             alert(`Error al eliminar: ${error.message}`);
                         } else {
                             // Recargar página para mostrar cambios
                             window.location.reload();
                         }
                     } catch (err) {
                         console.error(err);
                         alert('Ocurrió un error inesperado');
                     } finally {
                         document.body.style.cursor = 'default';
                     }
                 }, message);
             }
        });
    });
</script>
