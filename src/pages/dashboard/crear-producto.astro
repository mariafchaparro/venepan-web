---
import DashboardLayout from '../../layouts/DashboardLayout.astro';

export const prerender = false;
---

<DashboardLayout currentPath='/dashboard/gestionar-productos', title='Dashboard | Alimentos Venepan'>
    <section class="flex flex-col p-12">
        <div class="flex items-center gap-2 mb-4">
            <img src="/icons/chevron-left.svg" alt="Flecha atrás" class="w-4" />

            <a href="/dashboard/gestionar-productos" class="text-gray-600 text-sm hover:underline">Volver</a>
        </div>

        <h1 class="main-title text-4xl mb-2 max-w-[800px]">Añadir producto</h1>
        <p class="text max-w-[70ch] text-gray-600">Crea y añade un nuevo producto al catálogo web de Venepan. Los datos ingresados aquí se mostrarán en la sección de detalles del producto.</p>
        
        <form action="" class="mt-6 w-[1000px] flex bg-white p-7 rounded-3xl card-shadow border border-gray-200 gap-7 items-stretch h-[490px]">
            <section class="flex flex-col gap-4 h-full w-1/2">
                <div class="flex flex-col gap-2">
                    <label for="nombre_producto" class="block text-sm font-medium text-gray-700">Nombre</label>
                    <input type="text" id="nombre_producto" name="nombre_producto" placeholder="Nombre del producto" required class="bg-slate-50 w-full text-gray-800 placeholder:text-sm border px-3 py-3 border-gray-300 rounded-2xl focus:ring-1 focus:ring-gray-300 focus:outline-none">
                </div>

                <div class="flex justify-between items-center gap-4">
                    <div class="flex flex-col gap-2 w-1/2">
                        <label for="categoria" class="block text-sm font-medium text-gray-700">Categoría</label>
                        <select name="categoria" id="categoria" required class="bg-slate-50 w-full text-gray-800 border px-3 py-3 border-gray-300 rounded-2xl focus:ring-1 focus:ring-gray-300 focus:outline-none">
                            <option value="panes">Panes</option>
                            <option value="cereales">Cereales</option>
                            <option value="soya">Soya</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-2 w-1/2">
                        <label for="peso" class="block text-sm font-medium text-gray-700">Peso</label>
                        <input type="number" id="peso" name="peso" placeholder="Peso del producto en gramos" required class="bg-slate-50 w-full placeholder:text-sm text-gray-800 border px-3 py-3 border-gray-300 rounded-2xl focus:ring-1 focus:ring-gray-300 focus:outline-none">
                    </div>
                </div>

                <div class="flex flex-col gap-2">
                    <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción</label>
                    <textarea name="descripcion" id="descripcion" rows="3" placeholder="Descripción del producto" required class="bg-slate-50 w-full text-gray-800 placeholder:text-sm border px-3 py-3 border-gray-300 rounded-2xl focus:ring-1 focus:ring-gray-300 focus:outline-none resize-none"></textarea>
                </div>

                <div class="flex flex-col gap-2">
                    <label for="beneficios" class="block text-sm font-medium text-gray-700">Beneficios</label>
                    <textarea name="beneficios" id="beneficios" rows="2" placeholder="Ingresa los beneficios del producto separados por comas. Ejemplo: Saludable, Bajo en grasas, Bajo en azúcares." required class="bg-slate-50 w-full text-gray-800 placeholder:text-sm border px-3 py-3 border-gray-300 rounded-2xl focus:ring-1 focus:ring-gray-300 focus:outline-none resize-none"></textarea>
                </div>
            </section>

            <section class="flex flex-col w-1/2 gap-6">
                <div class="flex flex-col gap-2 flex-grow">
                    <label class="block text-sm font-medium text-gray-700">Imagen</label>
                    <label 
                        for="imagen_producto" 
                        id="dropzone"
                        class="dropzone bg-slate-50 w-full h-full flex flex-col items-center justify-center text-center cursor-pointer border-2 border-gray-300 border-dashed rounded-2xl transition-all hover:border-gray-400 hover:bg-slate-100 overflow-hidden"
                    >
                        <input type="file" id="imagen_producto" name="imagen_producto" accept="image/*" required class="hidden">
                        <div id="dropzone-text" class="text-gray-400 px-6 flex flex-col gap-3 items-center">
                            <p class="max-w-[30ch]"><span class="font-semibold text-gray-500">Haz click</span> para subir una foto o <span class="font-semibold text-gray-500">arrástrala</span> hasta el cuadro.</p>
                            <p class="text-sm max-w-[40ch]">La imagen del producto no debe tener fondo, debe tener un tamaño de 492px de alto y un formato webp.</p>
                        </div>
                        <img id="preview-image" class="hidden h-48 w-48 object-contain rounded-xl p-2" alt="Preview">
                    </label>
                </div>
                <div class="flex gap-2 justify-end">
                    <button class="dashboard-btn">Guardar producto</button>
                    <button class="dashboard-btn bg-white hover:bg-gray-100 w-full text-gray-700 border border-gray-300 ">Cancelar</button>
                </div>
            </section>
        </form>
    </section>
</DashboardLayout>

<script>
    const dropzone = document.getElementById('dropzone') as HTMLLabelElement | null;
    const fileInput = document.getElementById('imagen_producto') as HTMLInputElement | null;
    const dropzoneText = document.getElementById('dropzone-text') as HTMLDivElement | null;
    const previewImage = document.getElementById('preview-image') as HTMLImageElement | null;

    if (dropzone && fileInput && dropzoneText && previewImage) {
        // Prevenir comportamiento default del navegador
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, (e: Event) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        // Efecto visual al arrastrar sobre la zona
        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => {
                dropzone.classList.add('border-blue-400', 'bg-blue-50');
                dropzone.classList.remove('border-gray-300', 'bg-slate-50');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => {
                dropzone.classList.remove('border-blue-400', 'bg-blue-50');
                dropzone.classList.add('border-gray-300', 'bg-slate-50');
            });
        });

        // Manejar el drop
        dropzone.addEventListener('drop', (e: DragEvent) => {
            const files = e.dataTransfer?.files;
            if (files && files.length > 0 && files[0].type.startsWith('image/')) {
                fileInput.files = files;
                showPreview(files[0]);
            }
        });

        // Manejar selección por click
        fileInput.addEventListener('change', () => {
            if (fileInput.files && fileInput.files.length > 0) {
                showPreview(fileInput.files[0]);
            }
        });

        // Mostrar preview de la imagen
        function showPreview(file: File): void {
            const reader = new FileReader();
            reader.onload = (e: ProgressEvent<FileReader>) => {
                if (e.target?.result && previewImage && dropzoneText) {
                    previewImage.src = e.target.result as string;
                    previewImage.classList.remove('hidden');
                    dropzoneText.classList.add('hidden');
                }
            };
            reader.readAsDataURL(file);
        }
    }
</script>
